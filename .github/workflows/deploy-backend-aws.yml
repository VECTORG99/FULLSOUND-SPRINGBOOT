name: Deploy Backend to AWS Learner Lab

on:
  push:
    branches: [main]
    paths:
      - 'BackEnd/Fullsound/**'
      - '.github/workflows/deploy-backend-aws.yml'
  workflow_dispatch:

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout Backend code
        uses: actions/checkout@v4
      
      - name: Download latest frontend build
        run: |
          echo "Downloading latest frontend build from GitHub releases..."
          
          RELEASE_URL="https://api.github.com/repos/Axel-DaMage/FullSound_React/releases/latest"
          
          curl -L -H "Authorization: token ${{ secrets.GITHUB_TOKEN }}" \
            -H "Accept: application/vnd.github+json" \
            "$RELEASE_URL" > release.json
          
          cat release.json
          
          DOWNLOAD_URL=$(cat release.json | grep "browser_download_url.*frontend-build.zip" | cut -d '"' -f 4)
          
          if [ -z "$DOWNLOAD_URL" ]; then
            echo "ERROR: No frontend build found in latest release"
            echo "Please ensure frontend has been built and released first"
            exit 1
          fi
          
          echo "Downloading from: $DOWNLOAD_URL"
          curl -L -H "Authorization: token ${{ secrets.GITHUB_TOKEN }}" \
            -o frontend-build.zip "$DOWNLOAD_URL"
          
          echo "Frontend build downloaded successfully"
          ls -lh frontend-build.zip
      
      - name: Extract frontend build to static resources
        run: |
          echo "Extracting frontend build..."
          mkdir -p BackEnd/Fullsound/src/main/resources/static
          unzip -o frontend-build.zip -d BackEnd/Fullsound/src/main/resources/static/
          echo "Files extracted successfully"
          ls -la BackEnd/Fullsound/src/main/resources/static/
      
      - name: Set up JDK 17
        uses: actions/setup-java@v3
        with:
          java-version: '17'
          distribution: 'temurin'
          cache: maven
      
      - name: Verify Maven and Java
        run: |
          java -version
          mvn -version
          ls -la BackEnd/Fullsound/
      
      - name: Build Backend with Maven
        working-directory: ./BackEnd/Fullsound
        run: |
          echo "Building backend with embedded frontend..."
          mvn clean package -DskipTests -X
          echo "Build completed"
          ls -la target/
      
      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-session-token: ${{ secrets.AWS_SESSION_TOKEN }}
          aws-region: us-east-1
      
      - name: Create S3 bucket if not exists
        run: |
          BUCKET_NAME="fullsound-deployments-${{ secrets.AWS_ACCOUNT_ID }}"
          aws s3 mb s3://${BUCKET_NAME} --region us-east-1 2>/dev/null || echo "Bucket already exists"
      
      - name: Upload JAR to S3
        working-directory: ./BackEnd/Fullsound
        run: |
          BUCKET_NAME="fullsound-deployments-${{ secrets.AWS_ACCOUNT_ID }}"
          TIMESTAMP=$(date +%Y%m%d-%H%M%S)
          
          # Buscar el JAR generado
          JAR_FILE=$(ls target/*.jar | head -n 1)
          
          if [ -z "$JAR_FILE" ]; then
            echo "ERROR: No JAR file found in target directory"
            ls -la target/
            exit 1
          fi
          
          echo "Found JAR file: $JAR_FILE"
          
          echo "Uploading versioned JAR..."
          aws s3 cp $JAR_FILE \
            s3://${BUCKET_NAME}/fullsound-backend-${TIMESTAMP}.jar \
            --metadata "commit-sha=${{ github.sha }},branch=${{ github.ref_name }}"
          
          echo "Uploading latest JAR..."
          aws s3 cp $JAR_FILE \
            s3://${BUCKET_NAME}/fullsound-backend-latest.jar \
            --metadata "commit-sha=${{ github.sha }},branch=${{ github.ref_name }},timestamp=${TIMESTAMP}"
          
          echo "JAR uploaded successfully"
          echo "BUCKET_NAME=${BUCKET_NAME}" >> $GITHUB_ENV
          echo "JAR_VERSION=${TIMESTAMP}" >> $GITHUB_ENV
      
      - name: Check for EC2 instance
        id: check-ec2
        run: |
          echo "Checking for EC2 instance..."
          INSTANCE_ID=$(aws ec2 describe-instances \
            --filters "Name=tag:Name,Values=fullsound-backend" \
                      "Name=instance-state-name,Values=running" \
            --query "Reservations[0].Instances[0].InstanceId" \
            --output text 2>/dev/null || echo "None")
          
          if [ "$INSTANCE_ID" != "None" ] && [ ! -z "$INSTANCE_ID" ]; then
            echo "EC2 instance found: $INSTANCE_ID"
            echo "instance-id=$INSTANCE_ID" >> $GITHUB_OUTPUT
            echo "instance-exists=true" >> $GITHUB_OUTPUT
            
            PUBLIC_IP=$(aws ec2 describe-instances \
              --instance-ids $INSTANCE_ID \
              --query "Reservations[0].Instances[0].PublicIpAddress" \
              --output text)
            echo "public-ip=$PUBLIC_IP" >> $GITHUB_OUTPUT
          else
            echo "No running EC2 instance found"
            echo "instance-exists=false" >> $GITHUB_OUTPUT
          fi
      
      - name: Deploy to EC2 (if exists)
        if: steps.check-ec2.outputs.instance-exists == 'true'
        run: |
          INSTANCE_ID="${{ steps.check-ec2.outputs.instance-id }}"
          
          echo "Deploying to EC2 instance: $INSTANCE_ID"
          echo "Downloading deployment script..."
          
          # Ejecutar script de deployment desde GitHub
          COMMAND_ID=$(aws ssm send-command \
            --instance-ids "$INSTANCE_ID" \
            --document-name "AWS-RunShellScript" \
            --parameters 'commands=[
              "export DB_PASSWORD=\"${{ secrets.DB_PASSWORD }}\"",
              "export JWT_SECRET=\"${{ secrets.JWT_SECRET }}\"",
              "curl -fsSL https://raw.githubusercontent.com/VECTORG99/FULLSOUND-SPRINGBOOT/main/scripts/deploy-ec2.sh -o /tmp/deploy.sh",
              "chmod +x /tmp/deploy.sh",
              "/tmp/deploy.sh"
            ]' \
            --region us-east-1 \
            --output text \
            --query 'Command.CommandId')
          
          echo "Deployment command sent: $COMMAND_ID"
          echo "Waiting for deployment to complete..."
          sleep 20
          
          # Obtener resultado
          aws ssm get-command-invocation \
            --command-id "$COMMAND_ID" \
            --instance-id "$INSTANCE_ID" \
            --region us-east-1 \
            --query 'StandardOutputContent' \
            --output text || echo "Could not retrieve deployment output"
      
      - name: Deployment Summary
        run: |
          echo "================================"
          echo "DEPLOYMENT SUMMARY"
          echo "================================"
          echo ""
          echo "S3 Bucket: ${{ env.BUCKET_NAME }}"
          echo "JAR File: fullsound-backend-latest.jar"
          echo "Version: ${{ env.JAR_VERSION }}"
          echo "Commit: ${{ github.sha }}"
          echo "Branch: ${{ github.ref_name }}"
          echo ""
          
          if [ "${{ steps.check-ec2.outputs.instance-exists }}" == "true" ]; then
            echo "EC2 Instance: ${{ steps.check-ec2.outputs.instance-id }}"
            echo "Public IP: ${{ steps.check-ec2.outputs.public-ip }}"
            echo "Backend URL: http://${{ steps.check-ec2.outputs.public-ip }}:8080"
            echo "Health Check: http://${{ steps.check-ec2.outputs.public-ip }}:8080/actuator/health"
            echo ""
            echo "NOTE: Deployment via SSM attempted. Verify manually if needed."
          else
            echo "No EC2 instance running"
            echo ""
            echo "MANUAL DEPLOYMENT REQUIRED:"
            echo "1. Create EC2 instance with tag Name=fullsound-backend"
            echo "2. SSH into instance: ssh -i vockey.pem ec2-user@<EC2-IP>"
            echo "3. Run setup: curl -fsSL https://raw.githubusercontent.com/VECTORG99/FULLSOUND-SPRINGBOOT/main/scripts/setup-ec2.sh | bash"
            echo "4. Configure secrets and deploy: export DB_PASSWORD='***' JWT_SECRET='***' && curl -fsSL https://raw.githubusercontent.com/VECTORG99/FULLSOUND-SPRINGBOOT/main/scripts/deploy-ec2.sh | bash"
          fi
          echo ""
          echo "================================"
      
      - name: Create deployment artifact info
        run: |
          cat > deployment-info.json << EOF
          {
            "timestamp": "${{ env.JAR_VERSION }}",
            "commit_sha": "${{ github.sha }}",
            "branch": "${{ github.ref_name }}",
            "bucket": "${{ env.BUCKET_NAME }}",
            "jar_file": "fullsound-backend-latest.jar",
            "ec2_instance_id": "${{ steps.check-ec2.outputs.instance-id }}",
            "ec2_public_ip": "${{ steps.check-ec2.outputs.public-ip }}"
          }
          EOF
          
          aws s3 cp deployment-info.json \
            s3://${{ env.BUCKET_NAME }}/deployment-info.json
